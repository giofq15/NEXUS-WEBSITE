<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro de Morador - NEXUS</title>
    <link rel="stylesheet" href="../../public/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>

<body class="admin-body">

    <div class="sidebar">
        <div class="sidebar-header">
            <div class="nexus-brand" aria-label="Nexus Admin">
                <img src="../../public/img/nexus-logo.svg" alt="Logo Nexus" class="nexus-brand-mark">
                <div class="nexus-brand-text">
                    <strong>NEXUS</strong>
                    <span>ADMIN</span>
                </div>
            </div>
        </div>
        <nav>
            <ul>
                <li><a href="painel-admin.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                <li class="active"><a href="moradores.html"><i class="fas fa-users"></i> Moradores</a></li>
                <li><a href="moradores-inadimplentes.html"><i class="fas fa-user-clock"></i> Moradores Inadimplentes</a></li>
                <li><a href="../ocorrencias/ocorrencias.html"><i class="fas fa-exclamation-triangle"></i> Ocorrências</a></li>
                <li><a href="../financeiro/financeiro.html"><i class="fas fa-dollar-sign"></i> Financeiro</a></li>
                <li><a href="../morador/monitoramento-iot.html"><i class="fas fa-chart-line"></i> Monitoramento IoT</a></li>
                <li><a href="../public/index.html"><i class="fas fa-sign-out-alt"></i> Sair</a></li>
            </ul>
        </nav>
    </div>

    <div class="main-content">
        <a href="moradores.html" class="back-button">
            <i class="fas fa-arrow-left"></i> Voltar para Moradores
        </a>

        <div class="form-container">
            <h2>Cadastro de Novo Morador</h2>
            <form id="morador-form">

                <fieldset class="form-section">
                    <legend><i class="fas fa-user"></i> Dados Pessoais</legend>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="nome">Nome Completo</label>
                            <input type="text" id="nome" required>
                        </div>
                        <div class="form-group">
                            <label for="cpf">CPF</label>
                            <input type="text" id="cpf" placeholder="000.000.000-00">
                        </div>
                        <div class="form-group">
                            <label for="nascimento">Data de Nascimento</label>
                            <input type="date" id="nascimento">
                        </div>
                        <div class="form-group">
                            <label for="telefone">Telefone</label>
                            <input type="tel" id="telefone" placeholder="(99) 99999-9999" required>
                        </div>
                    </div>
                </fieldset>

                <fieldset class="form-section">
                    <legend><i class="fas fa-home"></i> Unidade e Acesso</legend>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="bloco">Bloco / Torre</label>
                            <select id="bloco" required>
                                <option value="">Selecione...</option>
                                <option>A</option>
                                <option>B</option>
                                <option>C</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="unidade">Número da Unidade</label>
                            <input type="text" id="unidade" required placeholder="Ex: 101, 202">
                        </div>
                        <div class="form-group">
                            <label for="acesso">Status de Acesso</label>
                            <select id="acesso">
                                <option value="ATIVO">Ativo</option>
                                <option value="PENDENTE">Pendente</option>
                                <option value="BLOQUEADO">Bloqueado</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="email">E-mail de Acesso</label>
                            <input type="email" id="email" required placeholder="morador@email.com">
                        </div>
                    </div>
                </fieldset>

                <div class="button-group">
                    <button type="submit" class="submit-button" id="submit-btn">
                        <i class="fas fa-save"></i> Cadastrar Morador
                    </button>
                    <button type="reset" class="reset-button">
                        <i class="fas fa-eraser"></i> Limpar Campos
                    </button>
                </div>

            </form>
        </div>
        
        <footer class="content-footer">
            <p>&copy; 2025 Projeto Nexus. Todos os direitos reservados.</p>
        </footer>
    </div>

    <script>
        const token = localStorage.getItem('nexus_token');
        if (!token) window.location.href = '../public/login.html?role=admin';

        const form = document.getElementById('morador-form');
        const submitBtn = document.getElementById('submit-btn');
        const params = new URLSearchParams(window.location.search);
        const editId = params.get('id');

        // If editing, load existing data
        if (editId) {
            document.querySelector('h2').textContent = 'Editar Morador';
            submitBtn.innerHTML = '<i class="fas fa-save"></i> Salvar Alterações';

            fetch(`/api/moradores/${editId}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            })
            .then(res => res.json())
            .then(m => {
                document.getElementById('nome').value = m.nome;
                document.getElementById('cpf').value = m.cpf;
                if (m.nascimento) document.getElementById('nascimento').value = m.nascimento.split('T')[0];
                document.getElementById('telefone').value = m.telefone;
                document.getElementById('bloco').value = m.bloco;
                document.getElementById('unidade').value = m.unidade;
                document.getElementById('acesso').value = m.status;
                document.getElementById('email').value = m.user.email;
            });
        }

        form.addEventListener('submit', async function (e) {
            e.preventDefault();

            const body = {
                nome: document.getElementById('nome').value,
                cpf: document.getElementById('cpf').value,
                nascimento: document.getElementById('nascimento').value || null,
                telefone: document.getElementById('telefone').value,
                bloco: document.getElementById('bloco').value,
                unidade: document.getElementById('unidade').value,
                status: document.getElementById('acesso').value,
                email: document.getElementById('email').value,
            };

            const url = editId ? `/api/moradores/${editId}` : '/api/moradores';
            const method = editId ? 'PUT' : 'POST';

            submitBtn.disabled = true;
            submitBtn.textContent = 'Salvando...';

            try {
                const res = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`,
                    },
                    body: JSON.stringify(body),
                });

                const data = await res.json();

                if (!res.ok) {
                    alert(data.error || data.errors?.map(e => e.msg).join(', ') || 'Erro ao salvar');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-save"></i> ' + (editId ? 'Salvar Alterações' : 'Cadastrar Morador');
                    return;
                }

                alert(editId ? 'Morador atualizado com sucesso!' : 'Morador cadastrado com sucesso!');
                window.location.href = 'moradores.html';
            } catch {
                alert('Erro de conexão com o servidor');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-save"></i> ' + (editId ? 'Salvar Alterações' : 'Cadastrar Morador');
            }
        });
    </script>
</body>

</html>
<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfil de Morador - NEXUS</title>
    <link rel="stylesheet" href="../../public/css/style.css">
</head>

<body>
    <header>
        <div class="logo logo-with-mark" aria-label="Nexus Admin">
            <img src="../../public/img/nexus-logo.svg" alt="Logo Nexus" class="nexus-brand-mark">
            <div class="nexus-brand-text">
                <strong>NEXUS</strong>
                <span>ADMIN</span>
            </div>
        </div>
    </header>

    <main>
        <aside class="sidebar">
            <a href="../admin/painel-admin.html">Dashboard</a>
            <a href="../admin/moradores.html">Moradores</a>
            <a href="../admin/moradores-inadimplentes.html">Moradores Inadimplentes</a>
            <a href="../ocorrencias/ocorrencias.html">Ocorrências</a>
            <a href="../financeiro/financeiro.html">Financeiro</a>
            <a href="../morador/monitoramento-iot.html">Monitoramento IoT</a>
            <a href="../public/index.html">Sair</a>
        </aside>

        <section class="content">
            <div class="header-with-action">
                <h1 id="morador-title">Detalhes do Morador</h1>
                <a href="../admin/moradores.html" class="secondary-button back-button">← Voltar para Moradores</a>
            </div>

            <div class="profile-layout">
                <div class="profile-card info-card">
                    <h2>Informações de Contato</h2>
                    <p><strong>Status:</strong> <span id="morador-status" class="status-active"></span></p>
                    <p><strong>Unidade:</strong> <span id="morador-unidade"></span></p>
                    <p><strong>E-mail:</strong> <span id="morador-email"></span></p>
                    <p><strong>Telefone:</strong> <span id="morador-telefone"></span></p>
                    <p><strong>Data de Cadastro:</strong> <span id="morador-data"></span></p>
                    <a id="edit-link" href="#" class="primary-button full-width-btn edit-button">Editar Dados</a>
                </div>

                <div class="profile-details-column">

                    <div class="profile-card access-card">
                        <h2>Controle de Acesso (Veículos)</h2>
                        <div class="data-list" id="veiculos-list">
                            <p>Carregando...</p>
                        </div>
                        <button class="action-btn full-width-btn add-placa-btn" id="add-placa-btn">Adicionar Placa</button>
                    </div>

                    <div class="profile-card logs-card">
                        <h2>Logs e Histórico</h2>
                        <div class="data-list">
                            <p><strong>Ocorrências em Aberto:</strong> 1</p>
                            <p><strong>Economia Média (Água):</strong> 15% acima da média</p>
                            <a href="#" class="view-log-link">Ver Histórico de Ocorrências</a>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer>
        <p>&copy; 2025 Projeto Nexus. Todos os direitos reservados.</p>
    </footer>

    <script>
        const token = localStorage.getItem('nexus_token');
        if (!token) window.location.href = '../public/login.html?role=admin';

        const params = new URLSearchParams(window.location.search);
        const moradorId = params.get('id');

        if (!moradorId) window.location.href = '../admin/moradores.html';

        async function loadMorador() {
            try {
                const res = await fetch(`/api/moradores/${moradorId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) { window.location.href = '../admin/moradores.html'; return; }
                const m = await res.json();

                document.getElementById('morador-title').textContent = `Detalhes do Morador: ${m.nome}`;
                document.getElementById('morador-status').textContent = m.status.charAt(0) + m.status.slice(1).toLowerCase();
                document.getElementById('morador-unidade').textContent = `${m.unidade} - Bloco ${m.bloco}`;
                document.getElementById('morador-email').textContent = m.user.email;
                document.getElementById('morador-telefone').textContent = m.telefone;
                document.getElementById('morador-data').textContent = new Date(m.createdAt).toLocaleDateString('pt-BR');
                document.getElementById('edit-link').href = `../admin/novo-morador.html?id=${m.id}`;

                renderVeiculos(m.veiculos);
            } catch {
                alert('Erro ao carregar dados do morador');
            }
        }

        function renderVeiculos(veiculos) {
            const list = document.getElementById('veiculos-list');
            if (!veiculos.length) {
                list.innerHTML = '<p>Nenhum veículo cadastrado</p>';
                return;
            }
            list.innerHTML = veiculos.map((v, i) => {
                const tagClass = v.tipo === 'CARRO' ? 'tag-car' : 'tag-moto';
                const label = v.tipo === 'CARRO' ? 'Carro' : 'Moto';
                return `<p>
                    <strong>Placa ${i + 1}:</strong> ${v.placa} <span class="tag ${tagClass}">${label}</span>
                    <a href="#" class="action-link" onclick="removeVeiculo(${v.id}); return false;">Remover</a>
                </p>`;
            }).join('');
        }

        document.getElementById('add-placa-btn').addEventListener('click', async function () {
            const placa = prompt('Digite a placa do veículo (ex: ABC-1234):');
            if (!placa) return;
            const tipo = prompt('Tipo: CARRO ou MOTO?')?.toUpperCase();
            if (tipo !== 'CARRO' && tipo !== 'MOTO') { alert('Tipo inválido'); return; }

            try {
                const res = await fetch(`/api/moradores/${moradorId}/veiculos`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ placa, tipo }),
                });
                const data = await res.json();
                if (!res.ok) { alert(data.error || 'Erro ao adicionar veículo'); return; }
                loadMorador();
            } catch { alert('Erro de conexão'); }
        });

        async function removeVeiculo(veiculoId) {
            if (!confirm('Remover este veículo?')) return;
            try {
                await fetch(`/api/moradores/${moradorId}/veiculos/${veiculoId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` },
                });
                loadMorador();
            } catch { alert('Erro ao remover veículo'); }
        }

        loadMorador();
    </script>
</body>

</html>